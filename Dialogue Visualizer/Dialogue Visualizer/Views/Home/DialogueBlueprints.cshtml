@{
    ViewBag.Title = "Dialogue Blueprint";
}

<canvas id="canvas" width="800" height="600"></canvas>

@section scripts {
    <script>
        $(document).ready(function () {

            function AddNewBlock(block) {
                console.log(block);

                var element = $('<div>')
                    .addClass('dialogue-block draggable')
                    .attr('data-id', block.Id)
                    .css({
                        left: block.X + 'px',
                        top: block.Y + 'px'
                    })
                    .text(block.dialogue.speaker + ': ' + block.dialogue.text);

                element.mousedown(function (event) {
                    var startX = event.pageX - parseInt($(this).css('left'));
                    var startY = event.pageY - parseInt($(this).css('top'));

                    $(document).on('mousemove', function (event) {
                        var x = event.pageX - startX;
                        var y = event.pageY - startY;

                        element.css({
                            left: x + 'px',
                            top: Y + 'px'
                        });
                    });
                });

                $(document).on('mouseup', function (event) {
                    $(document).off('mousemove');
                });

                console.log($('#canvas'));
                $('#canvas').append(element);
            }

            function GetBlocks() {
                $.get("@Url.Action("GetDialogueBlocks", "Home")", function (blocks) {
                    $.each(blocks, function (index, block) {
                        AddNewBlock(block);
                    });
                });
            }

            GetBlocks();

            $('#canvas').on('dblclick', function (event) {
                var x = event.pageX - $(this).offset().left;
                var y = event.pageY - $(this).offset().top;

                var block = { dialogue: { speaker: "[speaker]", text: "[text]"} , x: x, y: y }

                $.post('@Url.Action("AddDialogueBlock", "Home")', block, function (result) {
                    if (result.success) {
                        AddNewBlock(block);
                    }
                })
            });

            $('form').submit(function (event) {
                event.preventDefault();

                var speaker = $('#Speaker').val();
                var text = $('#Text').val();
                var x = 0;
                var y = 0;

                var block = { dialogue: { speaker: speaker, text: text }, x: x, y: y }

                $.post('@Url.Action("AddDialogueBlock", "Home")', block, function (result) {
                    if (result.success) {
                        AddNewBlock(block);
                    }
                });
            });
        });
    </script>
}